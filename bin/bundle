#! /bin/sh

astro build
if [ "$1" = "dev" ]; then
  OPTS="--sourcemap --watch"
elif [ "$1" = "test" ]; then
  OPTS="--sourcemap"
else
  OPTS="--minify"
  (cd lib && rm *.js.map) >> /dev/null 2>&1
fi
rm -rf lib/*
npx esbuild src/index.ts --bundle $OPTS --target=ESnext --outfile=lib/index.js
npx esbuild src/attach.ts --bundle $OPTS --target=ESnext --outfile=lib/attach.js

sed '/__vtbag_inspection_chamber_DOM__/q' lib/attach.js > lib/attach.tmp
echo 'function htmlString(src, title) {return `' >> lib/attach.tmp
head -n -1 dist/InspectionChamber/index.html |tail -n +3 | sed -e 's/`/\\`/g' >> lib/attach.tmp
echo '`.replace("__vtbag_inspection_chamber_title__", title).replace("/vtbag_inspection_chamber_src__/", src);}' >> lib/attach.tmp
mv lib/attach.tmp lib/attach.js

if [ "$1" = "test" ]; then
  mkdir -p e2e/public/lib
  cp -a lib/* e2e/public/lib/
fi
#npx tsc
