#! /bin/sh

astro build
if [ "$1" = "dev" ]; then
  OPTS="--sourcemap --watch"
elif [ "$1" = "test" ]; then
  OPTS="--sourcemap"
else
  OPTS="--minify"
  (cd lib && rm *.js.map) >> /dev/null 2>&1
fi
rm -rf lib/*
npx esbuild src/index.ts --bundle $OPTS --target=ESnext --outfile=lib/index.js

cd dist
npx vite --config ../IC-vite.config.ts build 
cd -

npx esbuild src/attach.ts --bundle $OPTS --target=ESnext --outfile=lib/attach.js

mv lib/attach.js lib/attach.tmp
echo 'function htmlString(src, title) {return `' >> lib/attach.tmp
sed -e 's/<!DOCTYPE html><html>//' dist/IC/InspectionChamber/index.html | sed -e 's|</html>||' | sed -e 's/\([\\`$]\)/\\\1/g' >> lib/attach.tmp
echo '`.replace("__vtbag_inspection_chamber_title__", title).replace("/vtbag_inspection_chamber_src__/", src);}' >> lib/attach.tmp
mv lib/attach.tmp lib/attach.js

if [ "$1" = "test" ]; then
  mkdir -p e2e/public/lib
  cp -a lib/* e2e/public/lib/
fi
#npx tsc
