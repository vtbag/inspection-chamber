---
import ViewTransitionCapture from './ViewTransitionCapture.astro';
---

<ViewTransitionCapture />
<script>
import { ICElement } from './ic-element';
	import { ledGroup } from './led-group';

	class ICCaptures extends ICElement {
		captureMap = new Map<Element | null, VtbagIcViewTransitionCaptureElement>();
		protected render() {
			this.classList.add('panel');
			this.innerHTML =
				ledGroup({
					independent: true,
					groupName: 'capture-mode',
					checked: 'none',
					className: 'capture-options',
					alternatives: [
						{ id: 'old-only', value: 'old-only', label: 'Capture old images, only' },
						{ id: 'freeze-types', value: 'freeze-types', label: 'Freeze types' },
					],
				}) +
				`<p class="explainer"><i>Captures will be listed here when your page starts a view transition.</i></p>`;

			this.querySelector('.capture-options #old-only')!.addEventListener('change', (event) => {
				parent.__vtbag!.ic2!.captureOldOnly = (event.target as HTMLInputElement).checked;
			});
			this.querySelector('.capture-options #freeze-types')!.addEventListener('change', (event) => {
				const target = event.target as HTMLInputElement;
				target.classList.toggle('red', target.checked);
				parent.__vtbag!.ic2!.captureFreezeTypes = target.checked;
				if (!target.checked) {
					parent.location.reload();
				} else {
					self.addEventListener('ic-after-capture-old', (e) => {
						const detail = (e as CustomEvent).detail;
						const root = detail.root;
						if (root.ownerDocument.documentElement === root) {
							parent.document.documentElement.classList.add('action');
							detail.viewTransition.finished.finally(() => {
								parent.document.documentElement.classList.remove('action');
							});
						}
					});
				}
			});


		
			['ic-after-capture-old', 'ic-after-capture-new', 'ic-ready-error'].forEach((eventName) =>self.addEventListener(eventName, this.showCaptureResult));
		}
		showCaptureResult = (event: Event) => {
			const isOldCapture = event.type === 'ic-after-capture-old';
			const showOnlyOldCapture = parent.__vtbag!.ic2!.captureOldOnly ?? false;
			const transitionRoot = (event as CustomEvent).detail.root;

			if (isOldCapture !== showOnlyOldCapture && event.type !== 'ic-ready-error') return;

			this.querySelector('.explainer')?.remove();

			parent.__vtbag!.ic2!.vtMap?.keys().forEach((key) => {
				this.captureMap.get(key)?.remove();
				this.insertAdjacentHTML(
					'beforeend',
					`<vtbag-ic-view-transition-capture></vtbag-ic-view-transition-capture>`
				);
				const captureElement = this.lastElementChild as VtbagIcViewTransitionCaptureElement;
				this.captureMap.set(key, captureElement);
				captureElement.init(key, key ?? transitionRoot);
			});
		};
	}
	customElements.define('vtbag-ic-captures', ICCaptures);
</script>

<style is:global>
	@layer components {
		@scope (vtbag-ic-captures) {
			:scope {
				display: block;
				margin: 0 4px;

				view-transition-name: hold;
				.input-led-group.capture-options div {
					display: flex;
					justify-content: space-around;
				}
				p {
					margin: 4px;
					padding: 4px;
					font-size: 0.9rem;
				}
				.print {
					cursor: pointer;
					user-select: none;
				}
				strong {
					color: light-dark(#222, #ddd);
				}
				.highlight {
					color: light-dark(#222222, #dddddd);
					cursor: pointer;
				}
			}
		}
	}
</style>
