<script>
	import { hideMinmax, minmax, resizeMinmax, showMinmax } from './minmax';
	import { ICElement } from './ic-element';

	const initial =
		'Select an area on the page to identify the view transition pseudo element at that position.';

	class ICIdentify extends ICElement {
		render() {
			this.innerHTML = `<h3>Identify</h3><div id="identified-pseudos">${initial}</div>`;
			minmax(
				this.querySelector('#identified-pseudos')!,
				'minimized',
				'Pick pseudo from screen',
				undefined,
				undefined,
				(input) => {
					if (input.checked) {
						parent.document.documentElement.classList.remove('show-twins');
						this.querySelector<HTMLElement>('#identified-pseudos')!.innerHTML = initial;
					} else {
						parent.document.documentElement.classList.add('show-twins');
						document
							.querySelectorAll<HTMLInputElement>('vtbag-ic-scope input[type=range]')
							.forEach((slider) => {
								slider.dispatchEvent(new Event('input'));
							});
						parent.document
							.querySelectorAll('#twins div[data-title]')
							.forEach((div) => div.addEventListener('click', divPick));
					}
					function divPick(e: Event) {
						e.stopImmediatePropagation();
						resizeMinmax(input.parentElement as HTMLElement, () => pick(e as PointerEvent));
					}
				}
			);
			hideMinmax(this.querySelector<HTMLLabelElement>('vtbag-ic-identify label.minmax')!);
		}
		show() {
			showMinmax(this.querySelector<HTMLLabelElement>('label.minmax')!);
		}
		hide() {
			const minmax = this.querySelector<HTMLLabelElement>('label.minmax')!;
			const checkbox = minmax.querySelector('input')!;
			if (!checkbox.checked) checkbox.click();
			hideMinmax(minmax);
		}
	}
	function pseudo(div: HTMLElement) {
		return div.textContent!;
	}

	function pick(e: PointerEvent) {
		const target = e.target as HTMLElement;
		if (target?.tagName === 'DIV') {
			let content = (target.ownerDocument.elementsFromPoint(e.clientX, e.clientY) as HTMLElement[])
				.filter((el) => el.dataset.title)
				.map((el) => `<div ${el.dataset.stopped !== undefined? 'data-stopped' : ''}>${el.dataset.title}</div>`)
				.join('');

			const identifiedPseudos = document.querySelector<HTMLElement>('#identified-pseudos')!;
			identifiedPseudos.innerHTML = content;
			identifiedPseudos.querySelectorAll('div').forEach((div) => {
				div.addEventListener('click', async () => {
					const details =
						document.querySelector<VtbagIcPseudoDetailsElement>('vtbag-ic-pseudo-details');
					details?.set(pseudo(div));
				});
				div.addEventListener('pointerenter', () => {
					const what = pseudo(div);
					const it = parent.document.querySelector<HTMLDivElement>(
						`#twins div[data-title='${what}']`
					)!;
					let color = `darkred`;
					if (
						what.endsWith('::view-transition') ||
						what.includes('::view-transition-group-children(')
					) {
						color = 'light-dark(darkslategray, darkcyan)';
					} else if (what.includes('::view-transition-new(')) {
						color = 'darkolivegreen';
					} else if (what.includes('::view-transition-old(')) {
						color = 'light-dark(darkslateblue, slateblue)';
					} else if (what.includes('::view-transition-image-pair(')) {
						color = 'darkgoldenrod';
					}
					it.style.outline = `2px solid ${color}`;
					it.style.outlineOffset = '-2px';
					div.style.color = color;
				});
				div.addEventListener('pointerleave', () => {
					const what = pseudo(div);
					const it = parent.document.querySelector<HTMLDivElement>(
						`#twins div[data-title='${what}']`
					)!;
					it.style.outline = '';
					it.style.outlineOffset = '';
					div.style.color = '';
				});
			});
		}
	}
	customElements.define('vtbag-ic-identify', ICIdentify);
</script>

<style is:global>
	@layer components {
		@scope (vtbag-ic-identify) {
			:scope {
				display: block;
				grid-column: 1 / -1;
				padding: 0.5rem 0.75rem 0.5rem 0.75rem;
				background: light-dark(#f6f6f6, #0a0a0a);
				border-radius: 4px;
				border: 1px solid light-dark(#d6d6d6, #2a2a2a);
				box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.3);
				#identified-pseudos div {
					cursor: pointer;
					padding: 2px 4px;
					border-top: 1px solid light-dark(#d6d6d6, #2a2a2a);
					&[data-stopped] {
						color: light-dark(red, darkred);
					}
				}
			}
		}
		.shrinker:has(> vtbag-ic-identify) {
			overflow-y: auto;
		}
	}
</style>
