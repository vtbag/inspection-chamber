<script>
	import { moduleGroupMaps } from './capture';
	import { deriveCSSSelector } from './element-selector';
	import { displayName, linear, relocate, type Group } from './group';
	import { ICElement } from './ic-element';

	const initial = `Click a spot on the page to identify <b>elements with view transition names</b> at that position.<br>
		Close this panel to remove the identify boxes from the screen and enable normal page interactions.`;

	class ICIdentifyElements extends ICElement {
		tearDown() {
			parent.document
				.querySelector<HTMLIFrameElement>('#test-jig')
				?.contentDocument?.querySelector('#vtbag-ic-element-style')
				?.remove();
		}
		render() {
			this.classList.add('panel');

			const specimenDoc =
				parent.document.querySelector<HTMLIFrameElement>('#test-jig')?.contentDocument;
			const key = [...parent.__vtbag!.ic2!.vtMap?.keys()!][0];
			const features = parent.__vtbag!.ic2!.vtMap?.get(key);
			const group: Group | undefined = moduleGroupMaps.get(key)?.get('@')!;
			if (features?.crossDocument) relocate(group, specimenDoc!);
			const styles: string[] = [];
			linear(group)
				.splice(0, 1)
				.forEach((group) => {
					if (group.old?.element)
						styles.push(`:root.show-named-elements ${
							deriveCSSSelector(group.old.element) + (group.old!.pseudoElement || '')
						} {
							--vtbag-ic-old: ${displayName(group)}		
							outline: 2px dashed #888;
							outline-offset: -2px;
						}`);
					if (group.new?.element)
						styles.push(`:root.show-named-elements ${
							deriveCSSSelector(group.new.element) + (group.old!.pseudoElement || '')
						} {
							--vtbag-ic-new: ${displayName(group)}		
							outline: 2px dashed #888;
							outline-offset: -2px;
						}`);
				});
			specimenDoc?.head.insertAdjacentHTML('beforeend', `<style id="vtbag-ic-element-style">${styles.join('\n')}</style>`);

			this.innerHTML = `
			<details ${sessionStorage.getItem('ic-identify-elements-open') === 'true' ? 'open' : ''}>
				<summary>Identify elements with view transition names</summary>
				<div id="identified-elements">${initial}</div>
			</details>`;
			this.querySelector('details')!.addEventListener('toggle', (e) =>
				this.init((e.target as HTMLDetailsElement).open)
			);
			this.hide();
		}
		init(open: boolean) {
			sessionStorage.setItem('ic-identify-elements-open', open ? 'true' : 'false');
			const documentElement = parent.document.querySelector<HTMLIFrameElement>('#test-jig')?.contentDocument?.documentElement;
			documentElement?.classList.toggle('show-named-elements', open);
			documentElement?.[open ? 'addEventListener' : 'removeEventListener']('click', pick);
		}
		show() {
			this.style.display = 'block';
			this.init(this.querySelector<HTMLDetailsElement>('details')!.open);
		}
		hide() {
			this.style.display = 'none';
			this.querySelector('#identified-elements')!.innerHTML = initial;
		}
	}


	function pick(event: Event) {
		const e = event as PointerEvent;
		const target = e.target as HTMLElement;
			let content = (target.ownerDocument.elementsFromPoint(e.clientX, e.clientY) as HTMLElement[])
				.filter((el) => el.dataset.twin)
				.toReversed()
				.flatMap(
					(el) => {
						const  style = target.ownerDocument.defaultView?.getComputedStyle()
					}				)
				.join('');

			const identifiedElements = document.querySelector<HTMLElement>('#identified-elements')!;
			identifiedElements.innerHTML = content;
			identifiedElements.querySelectorAll('div').forEach((div) => {
				div.addEventListener('pointerenter', () => {
					const what = element(div);
					const it = [
						...parent.document.querySelectorAll<HTMLDivElement>(`#twins div[data-twin]`),
					].find((d) => d.dataset.twin === what)!;
					let color = `darkred`;
					if (
						what.endsWith('::view-transition') ||
						what.includes('::view-transition-group-children(')
					) {
						color = 'light-dark(darkslategray, darkcyan)';
					} else if (what.includes('::view-transition-new(')) {
						color = 'darkolivegreen';
					} else if (what.includes('::view-transition-old(')) {
						color = 'light-dark(darkslateblue, slateblue)';
					} else if (what.includes('::view-transition-image-pair(')) {
						color = 'darkgoldenrod';
					}
					it.style.outline = `2px solid ${color}`;
					it.style.outlineOffset = '-2px';
					div.style.color = color;
				});
				div.addEventListener('pointerleave', () => {
					const what = pseudo(div);
					const it = [
						...parent.document.querySelectorAll<HTMLDivElement>(`#twins div[data-twin]`),
					].find((d) => d.dataset.twin === what)!;
					it.style.outline = '';
					it.style.outlineOffset = '';
					div.style.color = '';
				});
			});
	}
	customElements.define('vtbag-ic-identify-elements', ICIdentifyElements);
</script>

<style is:global>
	@import './styles/devtools.css';
	@import './styles/details.css';
	@layer components {
		vtbag-ic-identify-elements {
			display: block;
			grid-column: 1 / -1;
			padding: 0.5rem 0.75rem 0.5rem 0.75rem;
			background: light-dark(#f6f6f6, #0a0a0a);
			border-radius: 4px;
			border: 1px solid light-dark(#d6d6d6, #2a2a2a);
			box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.3);
			#identified-pseudos div {
				cursor: pointer;
				padding: 2px 4px;
				border-top: 1px solid light-dark(#d6d6d6, #2a2a2a);
				&[data-current-details] {
					color: light-dark(black, white);
				}
				&[data-stopped] {
					color: light-dark(red, darkred);
				}
			}
			b {
				color: light-dark(black, white);
			}
		}
	}
</style>
