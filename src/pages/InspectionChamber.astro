---
import Main from '@/components/ic/Main.astro';
import { Font } from 'astro:assets';
import Window from '@/components/Window.astro';
---

<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, minimum-scale=1.0" />
		<title>__vtbag_inspection_chamber_title__</title>
		<Font cssVariable="--vtbag-ic-font-labels" preload />
		<Font cssVariable="--vtbag-ic-font-logo" preload />
		<Main />
	</head>
	<body>
		<div id="twins">
			<div id="default"></div>
		</div>
		<iframe
			id="your-page"
			src="/vtbag_inspection_chamber_src__/"
			style="height: 100%; width: calc(100% - 385px)"></iframe>
		<div id="dragBar"></div>
		<div id="dock" style="height: 100%; width: 360px;"></div>
		<Window style="display: none; z-index:2">
			<div slot="title" style="display: flex; flex-direction: row; align-items: center">
				<img id="logo" width="32" height="32" slot="title" src="/bot1.png" />
			</div>
		</Window>

		<script>
			import { setupHooks } from '@/ic2/hooks';
			import { mayStartViewTransition } from '@vtbag/utensil-drawer/may-start-view-transition';

			const iframe = document.getElementById('your-page')!;
			if (iframe) {
				const DRAG_BAR_WIDTH = 5;
				const DRAG_BAR_WIDTH_PX = DRAG_BAR_WIDTH + 'px';

				const twins = document.getElementById('twins')!;
				const dragBar = document.getElementById('dragBar')!;
				const dock = document.getElementById('dock')!;
				const win = dock!.nextElementSibling as HTMLElement;

				const srcdoc =
					`<html lang="en" style="overflow: clip">` +
					document.head.outerHTML +
					`<body style="display: flex; overflow: clip;">
			<vtbag-ic-main></vtbag-ic-main>
	</body>
</html>`;
				dock.insertAdjacentHTML(
					'afterbegin',
					`<iframe id="content" style="border: none; width: 100%; height: 100%; overflow: clip;"></iframe>`
				);
				dock.firstElementChild!.setAttribute('srcdoc', srcdoc);
				let side = 'w';
				let dragReference = 0;
				let dragOriginalSize = 0;
				let isDragging = false;
				let longTap: ReturnType<typeof setTimeout> | undefined;

				addEventListener('longTap', (event) => {
					if (event instanceof CustomEvent) {
						side = event.detail.side;
						if (!side) return;

						mayStartViewTransition(
							{ update: handleLongTap, types: ['longTap'] },
							{ useTypesPolyfill: 'always' }
						);
					}
				});

				dragBar.addEventListener('pointerdown', (e) => {
					e.preventDefault();
					isDragging = true;
					document.body.classList.add('dragging');
					dragBar.setPointerCapture(e.pointerId);
					dragReference = side === 'e' || side === 'w' ? e.clientX : e.clientY;
					const iframeRect = iframe.getBoundingClientRect();
					dragOriginalSize =
						side === 'e' || side === 'w'
							? iframeRect.right - iframeRect.left
							: iframeRect.bottom - iframeRect.top;
					longTap = setTimeout(() => {
						longTap = undefined;
						stopDragging();
						dispatchEvent(new CustomEvent('longTap', { detail: { side: 'x' } }));
					}, 500);
				});

				dragBar.addEventListener('pointermove', (e) => {
					if (!isDragging) return;
					let delta = (side === 'e' || side === 'w' ? e.clientX : e.clientY) - dragReference;
					if (longTap && Math.abs(delta) > 5) {
						clearTimeout(longTap);
						longTap = undefined;
					}
					switch (side) {
						case 'n':
							iframe.style.height =
								Math.max(100, Math.min(innerHeight - 100, delta + dragOriginalSize)) + 'px';
							break;
						case 's':
							iframe.style.height =
								Math.max(100, Math.min(innerHeight - 100, dragOriginalSize - delta)) + 'px';
							break;
						case 'w':
							iframe.style.width =
								Math.max(100, Math.min(innerWidth - 100, dragOriginalSize + delta)) + 'px';
							break;
						case 'e':
							iframe.style.width =
								Math.max(100, Math.min(innerWidth - 100, dragOriginalSize - delta)) + 'px';
							break;
					}
				});
				function stopDragging() {
					switch (side) {
						case 'n':
						case 's':
							dock.style.height =
								innerHeight - parseInt(iframe.style.height, 10) - DRAG_BAR_WIDTH + 'px';
							break;
						case 'e':
						case 'w':
							dock.style.width =
								innerWidth - parseInt(iframe.style.width, 10) - DRAG_BAR_WIDTH + 'px';
							break;
					}
					isDragging = false;
					document.body.classList.remove('dragging');
					if (longTap) {
						clearTimeout(longTap);
						longTap = undefined;
					}
				}
				dragBar.addEventListener('pointerup', stopDragging);
				dragBar.addEventListener('pointercancel', stopDragging);

				async function handleLongTap() {
					const content = document.querySelector<HTMLElement>('#content')!;
					const {
						top: winTop,
						left: winLeft,
						bottom: winBottom,
						right: winRight,
					} = win.getBoundingClientRect();

					document.body.innerHTML = '';

					if (side === 'x') {
						document.body.append(twins, iframe, win);
						document.body.style.display = 'block';
						twins.style.width = iframe.style.width = '100%';
						twins.style.height = iframe.style.height = '100%';
						win.insertAdjacentElement('beforeend', content);
						dragBar.style.display = 'none';
						dock.style.display = 'none';
						win.style.display = 'flex';
						content.style.flex = '1 1 auto';
						content.style.height = '';
					} else {
						document.body.style.display = 'flex';
						dock.appendChild(content);
						content.style.height = '100%';
						content.style.width = '100%';
						content.style.flex = '';
						dock.style.display = 'block';
						dragBar.style.display = 'block';
						win.style.display = 'none';
						const len = side.length;
						if (len > 1) {
							side = matchMedia('(orientation: portrait)').matches ? side[0] : side[len - 1];
						}
						switch (side) {
							case 'n':
							case 's':
								document.body.style.flexDirection = 'column';
								dragBar.style.width =
									twins.style.width =
									iframe.style.width =
									dock.style.width =
										'100%';
								dragBar.style.height = DRAG_BAR_WIDTH_PX;
								dragBar.style.cursor = 'row-resize';
								dock.style.height = '';
								break;
							case 'e':
							case 'w':
								document.body.style.flexDirection = 'row';
								dragBar.style.height =
									twins.style.height =
									iframe.style.height =
									dock.style.height =
										'100%';
								dragBar.style.width = DRAG_BAR_WIDTH_PX;
								dragBar.style.cursor = 'col-resize';
								break;
						}
						switch (side) {
							case 'n':
								document.body.append(twins, iframe, dragBar, dock);
								twins.style.height = iframe.style.height = winTop + 'px';
								break;
							case 's':
								document.body.append(dock, dragBar, twins, iframe);
								twins.style.height = iframe.style.height = innerHeight - winBottom + 'px';
								break;
							case 'e':
								document.body.append(dock, dragBar, twins, iframe);
								twins.style.width = iframe.style.width = innerWidth - winRight + 'px';
								break;
							case 'w':
								document.body.append(twins, iframe, dragBar, dock);
								twins.style.width = iframe.style.width = winLeft + 'px';

								break;
						}
						switch (side) {
							case 'n':
							case 's':
								dock.style.height =
									innerHeight - parseInt(iframe.style.height, 10) - DRAG_BAR_WIDTH + 'px';
								break;
							case 'e':
							case 'w':
								dock.style.width =
									innerWidth - parseInt(iframe.style.width, 10) - DRAG_BAR_WIDTH + 'px';
								break;
						}
					}
					let iframeWindow = document.querySelector<HTMLIFrameElement>('#content')!.contentWindow!;
					self.__vtbag.ic2!.context = iframeWindow;
				}
				setupHooks(document.querySelector<HTMLIFrameElement>('#content')!.contentWindow!);
				self.__vtbag.ic2!.intersectionObserver = new IntersectionObserver(
					(entries) => {
						entries.forEach((entry) => {
							const link = (entry.target as HTMLElement).dataset.title;
							if (!link) return;
							self.__vtbag
								.ic2!.context?.document.querySelector<VtbagIcPseudoElement>(
									`vtbag-ic-pseudo[data-link="${link}"]`
								)
								?.onIntersectionChange(entry);
						});
					},
					{
						root: document.querySelector<HTMLIFrameElement>('#twins')!,
						threshold: 0,
					}
				);
			}
		</script>
		<style is:global>
			body {
				display: flex;
				flex-direction: row;
				overflow: hidden;
				margin: 0;
				height: 100%;
				width: 100%;
			}

			#dragBar {
				display: block;
				height: 100%;
				width: 5px;
				cursor: col-resize;
			}
			#content {
				border: none;
				width: 100%;
				height: 100%;
				overflow: clip;
			}
			#twins {
				contain: strict;
				display: block;
				pointer-events: none;
				z-index: 1;
				position: absolute;
				inset: 0;
				right: 425px;
				overflow: clip;
			}

			:root.show-twins #twins {
				cursor: help;
				div[data-title] {
					outline: 1px dotted #8888;
					&:hover:hover:not(:has(*:hover)) {
						background-color: #8882;
					}
				}
				div[data-stopped] {
					outline: 2px solid light-dark(red, darkred);
					outline-offset: -2px;
				}
				div[data-title$='::view-transition'] {
					pointer-events: auto;
				}
			}

			:active-view-transition-type(minimize) {
				.window {
					view-transition-name: window;
					iframe {
						view-transition-name: window-content;
					}
				}
				#logo {
					view-transition-name: logo;
				}
				#minimize-btn {
					view-transition-name: minimize-btn;
				}
				&::view-transition-group(window-content) {
					display: none;
				}
			}
		</style>
	</body>
</html>
